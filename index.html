<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>启中表白墙</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: radial-gradient(circle at top, #12001e, #000);
  color: #fff;
  overflow-x: hidden;
}

/* 粒子背景 */
canvas#bg {
  position: fixed;
  width: 100%;
  height: 100%;
  z-index: 0;
  top: 0;
  left: 0;
}

/* 容器 */
.container {
  position: relative;
  z-index: 1;
  padding: 20px;
  max-width: 700px;
  margin: 0 auto;
}

/* 分页按钮 */
.navbar {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
}
.navbar button {
  background: rgba(100, 0, 180, 0.5);
  border: 1px solid rgba(255,255,255,0.15);
  color: #fff;
  padding: 10px 18px;
  margin: 0 8px;
  border-radius: 10px;
  cursor: pointer;
  backdrop-filter: blur(8px);
  transition: 0.3s;
}
.navbar button.active {
  background: rgba(170, 0, 255, 0.6);
}
.navbar button:hover {
  transform: scale(1.05);
}

/* Liquid Glass 卡片 */
.post-card {
  backdrop-filter: blur(16px) saturate(180%);
  background-color: rgba(35, 0, 60, 0.5);
  border-radius: 18px;
  border: 1px solid rgba(255, 255, 255, 0.15);
  padding: 16px;
  margin-bottom: 20px;
  cursor: pointer;
  transition: all 0.3s;
}
.post-card:hover {
  transform: scale(1.02);
  background-color: rgba(70, 0, 110, 0.55);
}
.post-meta {
  margin-top: 10px;
  font-size: 0.9em;
  color: #bbb;
}
.post-card h4 {
  margin: 0;
  color: #bb86fc;
}

/* 弹窗评论 */
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  backdrop-filter: blur(18px);
  background-color: rgba(0,0,0,0.7);
  z-index: 999;
  align-items: center;
  justify-content: center;
}
.modal-content {
  background-color: rgba(40,0,70,0.8);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 20px;
  padding: 20px;
  width: 90%;
  max-width: 400px;
  color: #fff;
  max-height: 80%;
  overflow-y: auto;
}
.close-btn {
  float: right;
  cursor: pointer;
  font-size: 1.2em;
  color: #bb86fc;
}

/* 评论样式 */
.comment-item {
  margin: 10px 0;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  padding-bottom: 6px;
}
.comment-item b {
  color: #c8a2ff;
}
.comment-empty {
  text-align: center;
  color: #aaa;
  font-style: italic;
}

/* 下载分页 */
#downloadPage a {
  display: block;
  color: #bb86fc;
  text-align: center;
  text-decoration: none;
  font-weight: 600;
  padding: 14px;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 12px;
  margin: 10px 0;
  backdrop-filter: blur(8px);
  background: rgba(35,0,60,0.4);
}
#downloadPage a:hover {
  background: rgba(100,0,180,0.6);
}
</style>
</head>
<body>
<canvas id="bg"></canvas>

<div class="container">
  <div class="navbar">
    <button id="btnPosts" class="active">貼文</button>
    <button id="btnDownload">下載</button>
  </div>

  <div id="postsPage">
    <div id="postContainer"></div>
  </div>

  <div id="downloadPage" style="display:none;">
    <a href="https://github.com/jjsjshi/ChiWenBiaoBaiQiang/raw/refs/heads/main/%E5%90%AF%E4%B8%AD%E8%A1%A8%E7%99%BD%E5%A2%99_1.9.9.apk">⬇️ 下載最新版本</a>
  </div>
</div>

<!-- 评论弹窗 -->
<div class="modal" id="commentModal">
  <div class="modal-content">
    <span class="close-btn" id="closeModal">&times;</span>
    <h3 id="modalTitle"></h3>
    <div id="commentList"></div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCTYbT-1JJalcYSJpaGtd1S6gIRW2NIXAc",
    authDomain: "chiwenbbq.firebaseapp.com",
    databaseURL: "https://chiwenbbq-default-rtdb.firebaseio.com",
    projectId: "824364962555",
    storageBucket: "chiwenbbq.appspot.com",
    messagingSenderId: "824364962555",
    appId: "1:824364962555:web:example"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const postContainer = document.getElementById("postContainer");

  async function fetchPosts() {
    const snap = await get(child(ref(db), "posts"));
    const userSnap = await get(child(ref(db), "users"));
    if (!snap.exists()) return;

    const users = userSnap.exists() ? userSnap.val() : {};
    const posts = Object.values(snap.val()).sort((a, b) => (b.pin === "true") - (a.pin === "true"));
    postContainer.innerHTML = "";

    posts.forEach(post => {
      const user = Object.values(users).find(u => u.uid === post.uid);
      const author = user ? user.name : "匿名";
      const div = document.createElement("div");
      div.className = "post-card";
      div.innerHTML = `
        <h4>${post.pin === "true" ? "📌 " : ""}${author}</h4>
        <p>${post.content}</p>
        <div class="post-meta">❤️ ${post.like_count || 0}　💬 ${post.comment_count || 0}</div>
      `;
      div.addEventListener("click", () => openCommentModal(post, author));
      postContainer.appendChild(div);
    });
  }

  async function openCommentModal(post, author) {
    const modal = document.getElementById("commentModal");
    const commentList = document.getElementById("commentList");
    document.getElementById("modalTitle").textContent = `${author} 的貼文`;
    modal.style.display = "flex";
    commentList.innerHTML = "<p>載入中...</p>";

    const commentSnap = await get(child(ref(db), `comments/${post.childkey}`));
    if (!commentSnap.exists()) {
      commentList.innerHTML = `<p class="comment-empty">暫無評論</p>`;
      return;
    }
    const comments = Object.values(commentSnap.val());
    commentList.innerHTML = comments.map(c =>
      `<div class="comment-item"><b>${c.name || "匿名"}：</b>${c.text || ""}</div>`
    ).join("");
  }

  document.getElementById("closeModal").addEventListener("click", () => {
    document.getElementById("commentModal").style.display = "none";
  });

  fetchPosts();

  // 分页切换
  const btnPosts = document.getElementById("btnPosts");
  const btnDownload = document.getElementById("btnDownload");
  btnPosts.onclick = () => {
    btnPosts.classList.add("active");
    btnDownload.classList.remove("active");
    document.getElementById("postsPage").style.display = "block";
    document.getElementById("downloadPage").style.display = "none";
  };
  btnDownload.onclick = () => {
    btnDownload.classList.add("active");
    btnPosts.classList.remove("active");
    document.getElementById("postsPage").style.display = "none";
    document.getElementById("downloadPage").style.display = "block";
  };
</script>

<!-- 粒子背景 -->
<script src="https://cdn.jsdelivr.net/npm/particles.js"></script>
<script>
particlesJS("bg", {
  "particles": {
    "number": {"value": 70},
    "color": {"value": "#bb86fc"},
    "shape": {"type": "circle"},
    "opacity": {"value": 0.5},
    "size": {"value": 2},
    "move": {"enable": true, "speed": 1.5}
  }
});
</script>
</body>
</html>
